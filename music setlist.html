<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SETLIST / internal tool</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a24;
      --panel2:#0f1720;
      --text:#e7eef7;
      --muted:#9fb0c3;
      --line:#243244;
      --accent:#7dd3fc;
      --danger:#fb7185;
      --ok:#86efac;
      --warn:#fbbf24;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 60%, #06080c 100%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      letter-spacing:.02em;
    }
    header{
      padding:18px 14px 10px;
      position:sticky; top:0;
      background:rgba(11,15,20,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(36,50,68,.6);
      z-index:10;
    }
    h1{
      margin:0 0 6px; font-size:16px; font-weight:700;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:11px; color:var(--muted);
      border:1px solid rgba(36,50,68,.8);
      padding:2px 8px; border-radius:999px;
      background:rgba(18,26,36,.6);
    }
    .sub{
      margin:0; font-size:12px; color:var(--muted);
      display:flex; gap:10px; flex-wrap:wrap;
    }

    main{ padding:14px; max-width:900px; margin:0 auto; }

    .panel{
      background:rgba(18,26,36,.72);
      border:1px solid rgba(36,50,68,.8);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{ font-size:12px; color:var(--muted); display:block; margin:0 0 6px; }
    input, textarea, select{
      width:100%;
      background:rgba(15,23,32,.9);
      border:1px solid rgba(36,50,68,.9);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    input:focus, textarea:focus{
      border-color:rgba(125,211,252,.8);
      box-shadow:0 0 0 3px rgba(125,211,252,.15);
    }
    textarea{ min-height:42px; resize:vertical; }

    .row{
      display:grid;
      grid-template-columns: 1.5fr .6fr .6fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button{
      border:1px solid rgba(36,50,68,.9);
      background:rgba(15,23,32,.95);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
    }
    button:hover{ border-color:rgba(125,211,252,.6); }
    .primary{ background:rgba(125,211,252,.18); border-color:rgba(125,211,252,.5); }
    .danger{ background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.45); }
    .ghost{ background:transparent; }

    .summary{
      display:flex; gap:12px; flex-wrap:wrap;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(36,50,68,.8);
      font-size:12px;
      color:var(--muted);
    }
    .summary b{ color:var(--text); font-weight:750; }

    .list{
      margin-top:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      background:rgba(15,23,32,.8);
      border:1px solid rgba(36,50,68,.9);
      border-radius:14px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
    }
    .meta{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
      margin-top:6px;
    }
    .title{
      font-weight:800; font-size:14px;
      word-break:break-word;
    }
    .pill{
      border:1px solid rgba(36,50,68,.9);
      padding:2px 8px;
      border-radius:999px;
      background:rgba(18,26,36,.7);
    }
    .controls{
      display:flex; gap:6px; align-items:flex-start; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .mini{
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
    }
    .num{
      font-variant-numeric: tabular-nums;
    }
    .sep{ opacity:.7 }
    .hint{
      margin-top:10px; font-size:12px; color:var(--muted);
    }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background:rgba(18,26,36,.95);
      border:1px solid rgba(36,50,68,.9);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      z-index:99;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
<header>
  <h1>SETLIST <span class="badge">internal tool</span></h1>
  <p class="sub">
    <span>曲順変更 / 尺計算 / 書き出し</span>
    <span class="sep">•</span>
    <span>オフラインOK</span>
  </p>
</header>

<main>
  <div class="grid">
    <section class="panel">
      <div class="row">
        <div>
          <label for="eventName">現場名（任意）</label>
          <input id="eventName" placeholder="例）夜更けの小箱 / rehearsal #3" />
        </div>
        <div>
          <label for="startTime">開始時刻（任意）</label>
          <input id="startTime" type="time" />
        </div>
        <div>
          <label for="gapSec">曲間（秒）</label>
          <input id="gapSec" type="number" min="0" value="10" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label for="titleInput">曲名</label>
          <input id="titleInput" placeholder="例）ネオンの呼吸 / 逆光スローモーション" />
        </div>
        <div>
          <label for="minInput">分</label>
          <input id="minInput" type="number" min="0" value="3" />
        </div>
        <div>
          <label for="secInput">秒</label>
          <input id="secInput" type="number" min="0" max="59" value="20" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="noteInput">メモ（任意：キー/カポ/クリック/MC）</label>
        <input id="noteInput" placeholder="例）Key: Em / Capo:2 / MC短め / clickあり" />
      </div>

      <div class="btns">
        <button class="primary" id="addBtn">＋ 追加</button>
        <button id="addSampleBtn">それっぽい曲を補充</button>
        <button id="saveBtn">保存</button>
        <button class="ghost" id="loadBtn">読み込み</button>
        <button class="danger" id="clearBtn">全消し</button>
      </div>

      <div class="summary" id="summary">
        <span>曲数：<b class="num" id="count">0</b></span>
        <span>合計：<b class="num" id="total">0:00</b></span>
        <span>曲間込：<b class="num" id="totalWithGap">0:00</b></span>
        <span>終了：<b class="num" id="endTime">--:--</b></span>
      </div>

      <div class="btns">
        <button id="copyBtn">書き出し（コピー）</button>
      </div>

      <div class="hint">
        Tips：曲順は「↑ ↓」で入れ替え。曲名をタップしても編集できるようにしてある。
      </div>
    </section>

    <section class="panel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:800; font-size:14px;">曲順</div>
          <div style="font-size:12px; color:var(--muted); margin-top:4px;">本番用の見た目（番号 / 尺 / メモ）</div>
        </div>
        <button id="sortBtn" class="mini">尺が長い順</button>
      </div>

      <div class="list" id="list"></div>
    </section>
  </div>
</main>

<div class="toast" id="toast">copied</div>

<script>
  const el = (id) => document.getElementById(id);

  const state = {
    items: []
  };

  const samplePool = [
    { t:"ネオンの呼吸", d: "3:12", n:"Key: Am / click" },
    { t:"逆光スローモーション", d: "4:05", n:"Key: D / Capo:2" },
    { t:"雨粒のプロトコル", d: "3:48", n:"Key: Em / MC→曲入り" },
    { t:"深夜2:17の合図", d: "2:59", n:"Key: G / テンポ速め" },
    { t:"白線の向こう側", d: "4:22", n:"Key: Bm" },
    { t:"ハレーション・ノート", d: "3:33", n:"Key: C / サビで上げる" },
    { t:"静寂に火を点ける", d: "5:10", n:"Key: F#m / 伸ばし注意" },
    { t:"月明かりのエスケープ", d: "3:57", n:"Key: A / 2番カット可" },
    { t:"リバーブの海", d: "4:44", n:"Key: E / 長めアウトロ" },
    { t:"君の影にピントが合う", d: "3:26", n:"Key: Bb / 低めで" }
  ];

  function parseDur(minStr, secStr){
    const m = Math.max(0, parseInt(minStr || "0", 10));
    let s = Math.max(0, parseInt(secStr || "0", 10));
    s = Math.min(59, s);
    return m*60 + s;
  }

  function formatDur(totalSec){
    const m = Math.floor(totalSec/60);
    const s = totalSec % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function parseDurText(text){
    // "m:ss" or "mm:ss"
    const m = text.match(/^(\d+)\s*:\s*(\d{1,2})$/);
    if(!m) return 0;
    const mm = parseInt(m[1],10);
    const ss = Math.min(59, parseInt(m[2],10));
    return mm*60 + ss;
  }

  function calcSummary(){
    const gap = Math.max(0, parseInt(el("gapSec").value || "0",10));
    const count = state.items.length;
    const total = state.items.reduce((a,it)=>a+it.sec,0);
    const totalWithGap = total + (count>0 ? gap*(count-1) : 0);

    el("count").textContent = count;
    el("total").textContent = formatDur(total);
    el("totalWithGap").textContent = formatDur(totalWithGap);

    const st = el("startTime").value;
    if(st){
      const [hh,mm] = st.split(":").map(x=>parseInt(x,10));
      const startMin = hh*60 + mm;
      const endMin = startMin + Math.ceil(totalWithGap/60);
      const eh = Math.floor((endMin/60) % 24);
      const em = endMin % 60;
      el("endTime").textContent = `${String(eh).padStart(2,"0")}:${String(em).padStart(2,"0")}`;
    }else{
      el("endTime").textContent = "--:--";
    }
  }

  function render(){
    const list = el("list");
    list.innerHTML = "";

    state.items.forEach((it, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "item";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = `<span class="num">${idx+1}.</span> ${escapeHtml(it.title)}`;
      title.title = "タップして編集";
      title.style.cursor = "pointer";
      title.addEventListener("click", () => editItem(idx));

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span class="pill">DUR <span class="num">${formatDur(it.sec)}</span></span>
        ${it.note ? `<span class="pill">MEMO ${escapeHtml(it.note)}</span>` : ""}
      `;

      left.appendChild(title);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "controls";
      right.innerHTML = `
        <button class="mini" data-act="up">↑</button>
        <button class="mini" data-act="down">↓</button>
        <button class="mini danger" data-act="del">削除</button>
      `;

      right.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const act = btn.dataset.act;
        if(act === "up") move(idx, -1);
        if(act === "down") move(idx, +1);
        if(act === "del") remove(idx);
      });

      wrap.appendChild(left);
      wrap.appendChild(right);
      list.appendChild(wrap);
    });

    calcSummary();
  }

  function addItem(title, sec, note){
    state.items.push({
      title: title || "untitled",
      sec: Math.max(0, sec|0),
      note: note || ""
    });
    render();
  }

  function remove(idx){
    state.items.splice(idx,1);
    render();
  }

  function move(idx, delta){
    const j = idx + delta;
    if(j < 0 || j >= state.items.length) return;
    const tmp = state.items[idx];
    state.items[idx] = state.items[j];
    state.items[j] = tmp;
    render();
  }

  function editItem(idx){
    const it = state.items[idx];
    const newTitle = prompt("曲名", it.title);
    if(newTitle === null) return;
    const newDur = prompt("尺（m:ss）", formatDur(it.sec));
    if(newDur === null) return;
    const newNote = prompt("メモ（任意）", it.note || "");
    if(newNote === null) return;

    const sec = parseDurText(newDur.trim());
    it.title = newTitle.trim() || it.title;
    it.sec = sec || it.sec;
    it.note = newNote.trim();
    render();
  }

  function toast(msg){
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Buttons
  el("addBtn").addEventListener("click", () => {
    const title = el("titleInput").value.trim();
    const sec = parseDur(el("minInput").value, el("secInput").value);
    const note = el("noteInput").value.trim();
    if(!title){
      toast("曲名入れて〜");
      el("titleInput").focus();
      return;
    }
    addItem(title, sec, note);
    el("titleInput").value = "";
    el("noteInput").value = "";
    el("titleInput").focus();
  });

  el("addSampleBtn").addEventListener("click", () => {
    // add 3 random samples
    const pick = [...samplePool].sort(()=>Math.random()-0.5).slice(0,3);
    pick.forEach(p => addItem(p.t, parseDurText(p.d), p.n));
    toast("それっぽいの足した");
  });

  el("clearBtn").addEventListener("click", () => {
    if(confirm("全消しする？（保存してないと戻らない）")){
      state.items = [];
      render();
      toast("全消し");
    }
  });

  el("saveBtn").addEventListener("click", () => {
    const payload = {
      eventName: el("eventName").value,
      startTime: el("startTime").value,
      gapSec: el("gapSec").value,
      items: state.items
    };
    localStorage.setItem("setlist_internal_v1", JSON.stringify(payload));
    toast("保存した");
  });

  el("loadBtn").addEventListener("click", () => {
    const raw = localStorage.getItem("setlist_internal_v1");
    if(!raw){ toast("保存データなし"); return; }
    try{
      const payload = JSON.parse(raw);
      el("eventName").value = payload.eventName || "";
      el("startTime").value = payload.startTime || "";
      el("gapSec").value = payload.gapSec ?? 10;
      state.items = Array.isArray(payload.items) ? payload.items : [];
      render();
      toast("読み込みOK");
    }catch(e){
      toast("読み込み失敗");
    }
  });

  el("copyBtn").addEventListener("click", async () => {
    const name = el("eventName").value.trim();
    const gap = Math.max(0, parseInt(el("gapSec").value || "0",10));
    const header = [
      name ? `# ${name}` : `# SETLIST`,
      el("startTime").value ? `START ${el("startTime").value}` : "",
      `GAP ${gap}s`,
      ""
    ].filter(Boolean).join("\n");

    const lines = state.items.map((it,i) => {
      const memo = it.note ? `  |  ${it.note}` : "";
      return `${String(i+1).padStart(2,"0")}. ${it.title}  (${formatDur(it.sec)})${memo}`;
    }).join("\n");

    const total = state.items.reduce((a,it)=>a+it.sec,0);
    const totalWithGap = total + (state.items.length>0 ? gap*(state.items.length-1) : 0);
    const footer = `\n\nTOTAL ${formatDur(total)}  /  WITH GAP ${formatDur(totalWithGap)}`;

    const out = header + lines + footer;

    try{
      await navigator.clipboard.writeText(out);
      toast("コピーした");
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = out;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("コピーした(旧式)");
    }
  });

  el("sortBtn").addEventListener("click", () => {
    // sort desc by duration
    state.items.sort((a,b)=>b.sec-a.sec);
    render();
    toast("並べ替え");
  });

  // Recalc summary on settings change
  ["startTime","gapSec"].forEach(id=>{
    el(id).addEventListener("input", calcSummary);
  });

  // Init with a small set (それっぽい)
  (function init(){
    const initSet = [
      { t:"ネオンの呼吸", d:"3:12", n:"Key: Am / click" },
      { t:"雨粒のプロトコル", d:"3:48", n:"Key: Em / MC→曲入り" },
      { t:"白線の向こう側", d:"4:22", n:"Key: Bm" }
    ];
    initSet.forEach(p => addItem(p.t, parseDurText(p.d), p.n));
    calcSummary();
  })();
</script>
</body>
</html>
